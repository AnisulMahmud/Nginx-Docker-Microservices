# stages:
#   - build
#   - test
#   - deploy

# services:
#   - name: docker:dind

# variables:
#   DOCKER_DRIVER: overlay2
#   DOCKER_TLS_CERTDIR: ""

# build:
#   stage: build
#   script:
#     - echo "Building all services..."
#     - docker-compose build  # Build all services
#     - docker images  # Display built images
#   only:
#     - project
#     - main

# test:
#   stage: test
#   script:
#     - echo "Running tests ..."
#     - docker-compose up --build test  # Build and run the test service
#     - docker-compose down  # Clean up after testss
#   only:
#     - project
#     - main

# deploy:
#   stage: deploy
#   script:
#     - echo "Deploying services..."
#     - docker-compose up -d  # Start all services in detached mode
#     - docker-compose ps  # Show running containers
#   only:
#     - project
#     - main

stages:
  - build
  - test
  - deploy

services:
  - name: docker:dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  script:
    - echo "Building all services..."
    - docker-compose build
    - docker images
  only:
    - project
    - main

test:
  stage: test
  script:
    - echo "Running static analysis..."

    - echo "Running tests..."
    - docker-compose up --build test
    - curl -f http://localhost:8197/metrics || (echo "Metrics endpoint not accessible!" && exit 1)
    - docker-compose logs > test-logs.txt
    - docker-compose down
  artifacts:
    paths:
      - test-logs.txt
  only:
    - project
    - main

staging_deploy:
  stage: deploy
  script:
    - echo "Deploying to staging (project branch)..."
    - docker-compose up -d
    - docker-compose ps
  only:
    - project

production_deploy:
  stage: deploy
  script:
    - echo "Deploying to production (main branch)..."
    - docker-compose up -d
    - docker-compose ps
  only:
    - main

